{% extends "layout.html" %}

{% block title %}Course Editor{% endblock %}

{% block head %}
{{ super() }}
<style>
    .file-tree-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.75rem;
    }
    .file-tree-item .item-name {
        cursor: pointer;
    }
    .file-tree-item .item-actions {
        display: none;
    }
    .file-tree-item:hover .item-actions {
        display: block;
    }
    .item-actions .btn {
        padding: 0.1rem 0.4rem;
        font-size: 0.8rem;
    }
    .api-status {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-left: 5px;
    }
    .api-key-good {
        background-color: green;
    }
    .api-key-bad {
        background-color: red;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- File Tree Column -->
        <div class="col-md-4">
            <h4>
                Courses
                <button class="btn btn-sm btn-outline-success ms-2 new-folder-btn" data-path="">
                    <i class="fas fa-plus"></i> New Folder
                </button>
            </h4>
            <div id="file-tree">
                <!-- File tree will be loaded here by JavaScript -->
            </div>
        </div>

        <!-- Editor Column -->
        <div class="col-md-8">
            <div id="editor-container" style="display: none;">
                <h4 id="editing-filename"></h4>
                <form id="editor-form">
                    <input type="hidden" id="current-file-path" name="path">
                    <div class="form-group mb-2">
                        <textarea id="markdown-editor" name="content" class="form-control" rows="15"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Save</button>
                    <div class="btn-group">
                        <button type="button" id="generate-cards-btn" class="btn {{ 'btn-success' if gemini_api_key_exists or anthropic_api_key_exists else 'btn-secondary' }} dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" {% if not gemini_api_key_exists and not anthropic_api_key_exists %}disabled{% endif %}>
                            Generate Cards
                        </button>
                        <ul class="dropdown-menu">
                            {% if gemini_api_key_exists %}
                                <li><a class="dropdown-item" href="#" id="generate-cards-gemini-btn">Using Gemini</a></li>
                            {% endif %}
                            {% if anthropic_api_key_exists %}
                                <li><a class="dropdown-item" href="#" id="generate-cards-anthropic-btn">Using Anthropic</a></li>
                            {% endif %}
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="generate-cards-ollama-btn">Using Ollama (Local)</a></li>
                        </ul>
                    </div>
                    <button type="button" id="download-btn" class="btn btn-success">Download</button>
                </form>
                <hr>
                <h5>Live Preview</h5>
                <div id="live-preview" class="border p-3"></div>
            </div>
            <div id="no-file-selected" class="text-center text-muted pt-5">
                <p>Select a file to start editing or create a new one.</p>
            </div>
        </div>
    </div>
</div>

<!-- Card Generation Modal -->
<div class="modal fade" id="cards-modal" tabindex="-1" aria-labelledby="cardsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cardsModalLabel">Generated Cards</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="cards-modal-body-content"></div>
                <div id="loading-spinner" class="text-center" style="display: none;">
                    <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                    <p>Generating cards, please wait...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="save-cards-btn">Save Approved Cards</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const fileTreeContainer = document.getElementById('file-tree');
    const editorContainer = document.getElementById('editor-container');
    const noFileSelected = document.getElementById('no-file-selected');
    const markdownEditor = document.getElementById('markdown-editor');
    const livePreview = document.getElementById('live-preview');
    const editorForm = document.getElementById('editor-form');
    const editingFilename = document.getElementById('editing-filename');
    const currentFilePathInput = document.getElementById('current-file-path');
    const downloadBtn = document.getElementById('download-btn');
    const cardsModal = new bootstrap.Modal(document.getElementById('cards-modal'));
    const cardsModalBody = document.getElementById('cards-modal-body-content');
    const saveCardsBtn = document.getElementById('save-cards-btn');
    const loadingSpinner = document.getElementById('loading-spinner');

    let generatedCardsData = [];

    function loadFileTree() {
        fetch('/api/courses-tree')
            .then(response => response.json())
            .then(data => {
                fileTreeContainer.innerHTML = buildTreeHTML(data);
            });
    }

    function buildTreeHTML(nodes) {
        let html = '<div class="list-group">';
        nodes.forEach(node => {
            const padding = (node.depth || 0) * 20;
            if (node.type === 'directory') {
                html += `
                    <div style="padding-left: ${padding}px;">
                        <div class="list-group-item file-tree-item">
                            <span class="item-name" data-path="${node.path}">
                                <i class="fas fa-folder"></i> ${node.name}
                            </span>
                            <span class="item-actions">
                                <button class="btn btn-outline-success new-file-btn" data-path="${node.path}" title="New File"><i class="fas fa-plus"></i></button>
                                <button class="btn btn-outline-danger delete-item-btn" data-path="${node.path}" data-type="folder" title="Delete Folder"><i class="fas fa-trash-alt"></i></button>
                            </span>
                        </div>
                        ${node.children ? buildTreeHTML(node.children) : ''}
                    </div>
                `;
            } else {
                html += `
                    <div class="list-group-item file-tree-item" style="padding-left: ${padding}px;">
                        <span class="item-name file-item" data-path="${node.path}">
                            <i class="fas fa-file-alt"></i> ${node.title || node.name}
                        </span>
                        <span class="item-actions">
                            <button class="btn btn-outline-danger delete-item-btn" data-path="${node.path}" data-type="file" title="Delete File"><i class="fas fa-trash-alt"></i></button>
                        </span>
                    </div>
                `;
            }
        });
        html += '</div>';
        return html;
    }

    function createNewItem(type, parentPath) {
        const name = prompt(`Enter the name for the new ${type}:`);
        if (!name) return;

        const newPath = parentPath ? `${parentPath}/${name}` : name;
        const finalPath = type === 'file' && !newPath.endsWith('.md') ? `${newPath}.md` : newPath;

        fetch(`/api/course-item`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: finalPath, type: type })
        })
        .then(handleResponse)
        .then(() => {
            loadFileTree();
            if (type === 'file') {
                loadEditorContent(finalPath);
            }
        })
        .catch(handleError);
    }

    function deleteItem(path, type) {
        if (!confirm(`Are you sure you want to delete this ${type}: ${path}? This action cannot be undone.`)) {
            return;
        }

        fetch(`/api/course-item`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: path, type: type })
        })
        .then(handleResponse)
        .then(() => {
            loadFileTree();
            if (currentFilePathInput.value === path) {
                editorContainer.style.display = 'none';
                noFileSelected.style.display = 'block';
                currentFilePathInput.value = '';
                markdownEditor.value = '';
            }
        })
        .catch(handleError);
    }

    function loadEditorContent(path) {
        fetch(`/api/course-content/${path}`)
            .then(handleResponse)
            .then(content => {
                editorContainer.style.display = 'block';
                noFileSelected.style.display = 'none';
                editingFilename.textContent = `Editing: ${path}`;
                currentFilePathInput.value = path;
                markdownEditor.value = content;
                updatePreview();
            })
            .catch(handleError);
    }

    // --- Single, Delegated Event Listener ---
    document.body.addEventListener('click', function(e) {
        const target = e.target.closest('button, .file-item');
        if (!target) return;

        const path = target.dataset.path;

        if (target.classList.contains('file-item')) {
            loadEditorContent(path);
        } else if (target.classList.contains('new-file-btn')) {
            createNewItem('file', path);
        } else if (target.classList.contains('new-folder-btn')) {
            createNewItem('folder', path);
        } else if (target.classList.contains('delete-item-btn')) {
            const type = target.dataset.type;
            deleteItem(path, type);
        }
    });

    editorForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const path = currentFilePathInput.value;
        const content = markdownEditor.value;

        fetch(`/api/course-content`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: path, content: content })
        })
        .then(handleResponse)
        .then(() => alert('File saved successfully!'))
        .catch(handleError);
    });

    downloadBtn.addEventListener('click', function() {
        const path = currentFilePathInput.value;
        if (path) {
            window.location.href = `/api/download-course/${path}`;
        } else {
            alert('Please select a file to download.');
        }
    });

    function generateCards(apiUrl) {
        const content = markdownEditor.value;
        if (!content.trim()) {
            alert('Editor is empty. Please add some content before generating cards.');
            return;
        }

        cardsModalBody.innerHTML = '';
        loadingSpinner.style.display = 'block';
        saveCardsBtn.disabled = true;
        cardsModal.show();

        fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content })
        })
        .then(handleResponse)
        .then(data => {
            loadingSpinner.style.display = 'none';
            generatedCardsData = data.cards || [];
            if (generatedCardsData.length > 0) {
                displayGeneratedCards(generatedCardsData);
                saveCardsBtn.disabled = false;
            } else {
                cardsModalBody.innerHTML = '<p>No cards were generated. Try refining your course content.</p>';
            }
        })
        .catch(error => {
            loadingSpinner.style.display = 'none';
            cardsModalBody.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
            console.error('Error generating cards:', error);
        });
    }

    document.addEventListener('click', function(e) {
        if (e.target.matches('#generate-cards-gemini-btn')) {
            e.preventDefault();
            generateCards('/api/generate-cards');
        }
        if (e.target.matches('#generate-cards-anthropic-btn')) {
            e.preventDefault();
            generateCards('/api/generate-cards-anthropic');
        }
        if (e.target.matches('#generate-cards-ollama-btn')) {
            e.preventDefault();
            generateCards('/api/generate-cards-ollama');
        }
    });

    function displayGeneratedCards(cards) {
        let html = '<div id="generated-cards-container">';
        cards.forEach((card, index) => {
            const questionHTML = marked.parse(card.question || '');
            const answerHTML = marked.parse(card.answer || '');
            html += `
                <div class="card mb-3" data-card-index="${index}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="form-check">
                            <input class="form-check-input approve-checkbox" type="checkbox" id="approve-${index}" checked>
                            <label class="form-check-label" for="approve-${index}">
                                <strong>Card ${index + 1}</strong>
                            </label>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary edit-card-btn">Edit</button>
                            <button class="btn btn-sm btn-outline-danger delete-card-btn">Delete</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="card-content">
                            <p><strong>Q:</strong> <span class="card-question">${questionHTML}</span></p>
                            <p><strong>A:</strong> <span class="card-answer">${answerHTML}</span></p>
                        </div>
                        <div class="edit-form" style="display: none;">
                            <div class="mb-2">
                                <label class="form-label">Question:</label>
                                <textarea class="form-control edit-question">${card.question}</textarea>
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Answer:</label>
                                <textarea class="form-control edit-answer">${card.answer}</textarea>
                            </div>
                            <button class="btn btn-sm btn-success save-edit-btn">Save</button>
                            <button class="btn btn-sm btn-secondary cancel-edit-btn">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        cardsModalBody.innerHTML = html;
        if (window.MathJax) {
            MathJax.typesetPromise([cardsModalBody]);
        }
    }

    // --- Event Delegation for Modal Buttons ---
    cardsModalBody.addEventListener('click', function(e) {
        const target = e.target;
        const cardElement = target.closest('.card');
        if (!cardElement) return;

        const index = parseInt(cardElement.dataset.cardIndex, 10);

        if (target.classList.contains('delete-card-btn')) {
            generatedCardsData[index] = null; // Mark for deletion
            cardElement.remove();
        } else if (target.classList.contains('edit-card-btn')) {
            const cardData = generatedCardsData[index];
            cardElement.querySelector('.edit-question').value = cardData.question;
            cardElement.querySelector('.edit-answer').value = cardData.answer;
            cardElement.querySelector('.card-content').style.display = 'none';
            cardElement.querySelector('.edit-form').style.display = 'block';
        } else if (target.classList.contains('cancel-edit-btn')) {
            cardElement.querySelector('.card-content').style.display = 'block';
            cardElement.querySelector('.edit-form').style.display = 'none';
        } else if (target.classList.contains('save-edit-btn')) {
            const questionTextarea = cardElement.querySelector('.edit-question');
            const answerTextarea = cardElement.querySelector('.edit-answer');
            const newQuestion = questionTextarea.value;
            const newAnswer = answerTextarea.value;

            // Update data model
            generatedCardsData[index].question = newQuestion;
            generatedCardsData[index].answer = newAnswer;

            // Update the card's display view
            const questionSpan = cardElement.querySelector('.card-question');
            const answerSpan = cardElement.querySelector('.card-answer');
            questionSpan.innerHTML = marked.parse(newQuestion);
            answerSpan.innerHTML = marked.parse(newAnswer);

            // Ensure MathJax re-renders the new content
            if (window.MathJax) {
                MathJax.typesetPromise([questionSpan, answerSpan]);
            }

            // Hide the form and show the content
            cardElement.querySelector('.card-content').style.display = 'block';
            cardElement.querySelector('.edit-form').style.display = 'none';
        }
    });

    saveCardsBtn.addEventListener('click', function() {
        const approvedCards = [];
        const cardElements = cardsModalBody.querySelectorAll('.card');

        cardElements.forEach(cardElement => {
            const index = parseInt(cardElement.dataset.cardIndex, 10);
            const isApproved = cardElement.querySelector('.approve-checkbox').checked;

            if (isApproved && generatedCardsData[index]) {
                approvedCards.push(generatedCardsData[index]);
            }
        });

        if (approvedCards.length === 0) {
            alert("No approved cards to save.");
            return;
        }

        fetch('/api/save-cards', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cards: approvedCards })
        })
        .then(handleResponse)
        .then(data => {
            alert(data.message);
            cardsModal.hide();
        })
        .catch(handleError);
    });

    function handleResponse(response) {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.detail || `HTTP error! status: ${response.status}`) });
        }
        // Handle empty JSON responses for success cases like DELETE
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.indexOf("application/json") !== -1) {
            return response.json();
        }
        return {}; 
    }

    function handleError(error) {
        alert(`An error occurred: ${error.message}`);
        console.error(error);
    }

    markdownEditor.addEventListener('input', updatePreview);
    function updatePreview() {
        livePreview.innerHTML = marked.parse(markdownEditor.value);
        MathJax.typesetPromise([livePreview]);
    }

    // --- Initial Load ---
    loadFileTree();
    const initialPath = "{{ course_path|default('') }}";
    if (initialPath && initialPath !== 'home') {
        loadEditorContent(initialPath);
    }
});
</script>
{% endblock %}
