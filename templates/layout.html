<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bad Anki</title>
    <link rel="icon" href="{{ url_for('static', path='favicon.ico') }}" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" />

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<style>
    :root {
        --background-rgb: 255, 255, 255;
        --foreground-rgb: 33, 37, 41;
        --border-rgb: 214, 214, 214;
        --primary-rgb: 29, 78, 216;
        --muted-foreground-rgb: 108, 117, 125;
        --card-background-rgb: 255, 255, 255;
        --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.05);
        --radius: 0.5rem;
    }
    [data-bs-theme="dark"] {
        --background-rgb: 18, 18, 18;
        --foreground-rgb: 230, 230, 230;
        --border-rgb: 50, 50, 50;
        --primary-rgb: 59, 130, 246;
        --muted-foreground-rgb: 160, 160, 160;
        --card-background-rgb: 30, 30, 30;
        --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2), 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    *, *::before, *::after { box-sizing: border-box; }

    html, body {
        max-width: 100%;
        overflow-x: hidden;
        background-color: rgb(var(--background-rgb));
        color: rgb(var(--foreground-rgb));
        padding-top: 56px; /* Standard navbar height */
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    .navbar {
        background-color: rgba(var(--card-background-rgb), 0.8);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(var(--border-rgb), 0.5);
    }

    .navbar-brand, .nav-link { white-space: nowrap; }

    .card {
        background-color: rgb(var(--card-background-rgb));
        border: 1px solid rgba(var(--border-rgb), 0.7);
        box-shadow: var(--box-shadow);
        border-radius: var(--radius);
    }

    .btn-primary {
        background-color: rgb(var(--primary-rgb));
        border-color: rgb(var(--primary-rgb));
    }

    .theme-toggle {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        z-index: 1000;
        background-color: rgba(var(--card-background-rgb), 0.95);
        padding: 0.5rem;
        border-radius: var(--radius);
        box-shadow: var(--box-shadow);
        border: 1px solid rgba(var(--border-rgb), 0.5);
    }
    @media (max-width: 576px) {
        .theme-toggle {
            bottom: 0.5rem;
            right: 0.5rem;
            padding: 0.25rem 0.5rem;
            transform: scale(0.9);
        }
    }

    @media (max-width: 768px) {
        .home-hero {
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: calc(100vh - 56px); /* Full viewport height minus navbar */
        }
        body.home-page-active {
            overflow: hidden;
        }
    }

    main {
        padding-bottom: 5rem;
    }
    @media (max-width: 576px) {
        main { padding-bottom: 4rem; }
    }
</style>

<script>
window.MathJax = {
  tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] },
  svg: { fontCache: 'global' }
};
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    !function(){if(window.si)return;window.si=function(){(window.si.q=window.si.q||[]).push(arguments)};var a=document.createElement("script");a.defer=true;a.src="https://script.speed-insights.com/v2/script.js";document.head.appendChild(a);}();
</script>
{% block head %}{% endblock %}
</head>
<body>
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid">
            <!-- Hamburger Menu -->
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>

            <a class="navbar-brand" href="/"><i class="fas fa-brain"></i> Bad Anki</a>

            <!-- Desktop Nav -->
            <div class="collapse navbar-collapse justify-content-center d-none d-lg-flex" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a href="/" class="nav-link"><i class="fas fa-home"></i> Home</a></li>
                    <li class="nav-item"><a href="/review" class="nav-link"><i class="fas fa-star"></i> Review</a></li>
                    <li class="nav-item"><a href="/courses" class="nav-link"><i class="fas fa-book"></i> Courses</a></li>
                    <li class="nav-item"><a href="/edit-course/home" class="nav-link"><i class="fas fa-edit"></i> Editor</a></li>
                    <li class="nav-item"><a href="/manage" class="nav-link"><i class="fas fa-cog"></i> Manage</a></li>
                </ul>
            </div>

            <!-- User Profile Dropdown (fixed to simple dropdown) -->
            <div class="d-flex align-items-center">
                {% if request.state.user %}
                <div class="dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-user"></i> <span class="d-none d-sm-inline">{{ request.state.user.username }}</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><a class="dropdown-item" href="/api-keys">API Keys</a></li>
                        <li><a class="dropdown-item" href="/secrets">Manage Secrets</a></li>
                        <li><hr class="dropdown-divider d-lg-none"></li>
                        <li class="d-lg-none">
                            <a class="dropdown-item" href="#" id="themeToggleMobile">
                                <i class="fas fa-sun me-2" id="themeIconMobileSun"></i>
                                <i class="fas fa-moon me-2" id="themeIconMobileMoon"></i>
                                Toggle Theme
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/logout">Logout</a></li>
                    </ul>
                </div>
                {% else %}
                <a class="nav-link" href="/login">Login</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Offcanvas for mobile -->
    <div class="offcanvas offcanvas-start d-lg-none" tabindex="-1" id="offcanvasNavbar">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Menu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <ul class="navbar-nav">
                <li class="nav-item"><a href="/" class="nav-link"><i class="fas fa-home"></i> Home</a></li>
                <li class="nav-item"><a href="/review" class="nav-link"><i class="fas fa-star"></i> Review</a></li>
                <li class="nav-item"><a href="/courses" class="nav-link"><i class="fas fa-book"></i> Courses</a></li>
                <li class="nav-item"><a href="/edit-course/home" class="nav-link"><i class="fas fa-edit"></i> Editor</a></li>
                <li class="nav-item"><a href="/manage" class="nav-link"><i class="fas fa-cog"></i> Manage</a></li>
            </ul>
        </div>
    </div>

    <!-- Theme Toggle (Desktop) -->
    <div class="theme-toggle d-none d-lg-block">
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="themeSwitchDesktop">
            <label class="form-check-label" for="themeSwitchDesktop"><i class="fas fa-sun"></i> / <i class="fas fa-moon"></i></label>
        </div>
    </div>

    <main class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-md-8">{% block content %}{% endblock %}</div>
        </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Flash message handler
        const flashCookie = document.cookie.split('; ').find(row => row.startsWith('flash='));
        if (flashCookie) {
            const flashMessage = decodeURIComponent(flashCookie.split('=')[1]);
            const [status, message] = flashMessage.split(':');
            
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            });

            Toast.fire({
                icon: status,
                title: message
            });

            // Clear the cookie
            document.cookie = 'flash=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        }

        const themeSwitchDesktop = document.getElementById('themeSwitchDesktop');
        const themeToggleMobile = document.getElementById('themeToggleMobile');
        const themeIconMobileSun = document.getElementById('themeIconMobileSun');
        const themeIconMobileMoon = document.getElementById('themeIconMobileMoon');
        const html = document.documentElement;

        const updateIcons = (theme) => {
            if (themeToggleMobile) {
                const isDark = theme === 'dark';
                themeIconMobileSun.style.display = isDark ? 'none' : 'inline-block';
                themeIconMobileMoon.style.display = isDark ? 'inline-block' : 'none';
            }
        };

        const setTheme = (theme, shouldUpdateSwitches = true) => {
            html.setAttribute('data-bs-theme', theme);
            localStorage.setItem('theme', theme);
            if (shouldUpdateSwitches) {
                const isDark = theme === 'dark';
                if (themeSwitchDesktop) themeSwitchDesktop.checked = isDark;
            }
            updateIcons(theme);
        };

        const currentTheme = localStorage.getItem('theme') || 'light';
        setTheme(currentTheme);

        if (themeSwitchDesktop) {
            themeSwitchDesktop.addEventListener('change', () => {
                setTheme(themeSwitchDesktop.checked ? 'dark' : 'light');
            });
        }
        if (themeToggleMobile) {
            themeToggleMobile.addEventListener('click', (e) => {
                e.preventDefault();
                const newTheme = html.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
                setTheme(newTheme);
            });
        }

        const current = window.location.pathname;
        document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
            if (link.getAttribute('href') === current) link.classList.add('active');
        });
    });
    </script>
    {% block scripts %}{% endblock %}
    {% block modals_script %}
<script>
// --- Global Card Generation and Modal Logic ---
document.addEventListener('DOMContentLoaded', function () {
    const cardsModalElement = document.getElementById('cards-modal');
    if (!cardsModalElement) return; // Do nothing if the modal is not on the page

    const cardsModal = new bootstrap.Modal(cardsModalElement);
    const cardsModalBody = document.getElementById('cards-modal-body-content');
    const saveCardsBtn = document.getElementById('save-cards-btn');
    const loadingSpinner = document.getElementById('loading-spinner');
    const loadingMessage = document.getElementById('loading-message');
    
    let generatedCardsData = [];
    let messageInterval;
    const loadingMessages = [
        "Summoning digital flashcards...",
        "Teaching the AI to count in binary...",
        "Brewing coffee for the server hamsters...",
        "Reticulating splines...",
        "Asking the AI if it has any questions...",
        "Shuffling bits and bytes...",
        "Don't worry, the AI is a professional...",
        "Converting caffeine into code...",
        "Generating knowledge, one card at a time.",
        "The AI is thinking... or pretending to.",
        "Hold on, polishing the virtual cards."
    ];

    // This function is now globally available
    window.handleGenerateCards = function(apiUrl, contentProvider) {
        const content = contentProvider();
        if (!content || !content.trim()) {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'warning',
                title: 'Content is empty. Please add some text.',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
            return;
        }

        cardsModalBody.innerHTML = '';
        loadingSpinner.style.display = 'block';
        if(loadingMessage) loadingMessage.textContent = loadingMessages[0];
        saveCardsBtn.disabled = true;
        cardsModal.show();

        // Start showing random messages
        let messageIndex = 0;
        messageInterval = setInterval(() => {
            messageIndex = (messageIndex + 1) % loadingMessages.length;
            if(loadingMessage) loadingMessage.textContent = loadingMessages[messageIndex];
        }, 2500);

        fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.detail || `HTTP error! status: ${response.status}`) });
            }
            return response.json();
        })
        .then(data => {
            clearInterval(messageInterval);
            loadingSpinner.style.display = 'none';
            generatedCardsData = data.cards || [];
            if (generatedCardsData.length > 0) {
                displayGeneratedCards(generatedCardsData);
                saveCardsBtn.disabled = false;
            } else {
                cardsModalBody.innerHTML = '<p>No cards were generated. Try refining your course content.</p>';
            }
        })
        .catch(error => {
            clearInterval(messageInterval);
            loadingSpinner.style.display = 'none';
            cardsModalBody.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
            console.error('Error generating cards:', error);
        });
    }

    function displayGeneratedCards(cards) {
        let html = '<div id="generated-cards-container">';
        cards.forEach((card, index) => {
            const questionHTML = marked.parseInline(card.question || '');
            const answerHTML = marked.parseInline(card.answer || '');
            html += `
                <div class="card mb-3" data-card-index="${index}">
                    <div class="card-header d-flex flex-column flex-sm-row justify-content-sm-between align-items-start align-items-sm-center">
                        <div class="form-check">
                            <input class="form-check-input approve-checkbox" type="checkbox" id="approve-${index}" checked>
                            <label class="form-check-label" for="approve-${index}">
                                <strong>Card ${index + 1}</strong>
                            </label>
                        </div>
                        <div class="mt-2 mt-sm-0">
                            <button class="btn btn-sm btn-outline-primary edit-card-btn">Edit</button>
                            <button class="btn btn-sm btn-outline-danger delete-card-btn">Delete</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="card-content">
                            <p><strong>Q:</strong> <span class="card-question">${questionHTML}</span></p>
                            <p><strong>A:</strong> <span class="card-answer">${answerHTML}</span></p>
                        </div>
                        <div class="edit-form" style="display: none;">
                            <div class="mb-2">
                                <label class="form-label">Question:</label>
                                <textarea class="form-control edit-question">${card.question}</textarea>
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Answer:</label>
                                <textarea class="form-control edit-answer">${card.answer}</textarea>
                            </div>
                            <button class="btn btn-sm btn-success save-edit-btn">Save</button>
                            <button class="btn btn-sm btn-secondary cancel-edit-btn">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        cardsModalBody.innerHTML = html;
        if (window.MathJax) {
            MathJax.typesetPromise([cardsModalBody]);
        }
    }

    cardsModalBody.addEventListener('click', function(e) {
        const target = e.target;
        const cardElement = target.closest('.card');
        if (!cardElement) return;

        const index = parseInt(cardElement.dataset.cardIndex, 10);

        if (target.classList.contains('delete-card-btn')) {
            generatedCardsData[index] = null;
            cardElement.remove();
        } else if (target.classList.contains('edit-card-btn')) {
            const cardData = generatedCardsData[index];
            cardElement.querySelector('.edit-question').value = cardData.question;
            cardElement.querySelector('.edit-answer').value = cardData.answer;
            cardElement.querySelector('.card-content').style.display = 'none';
            cardElement.querySelector('.edit-form').style.display = 'block';
        } else if (target.classList.contains('cancel-edit-btn')) {
            cardElement.querySelector('.card-content').style.display = 'block';
            cardElement.querySelector('.edit-form').style.display = 'none';
        } else if (target.classList.contains('save-edit-btn')) {
            const questionTextarea = cardElement.querySelector('.edit-question');
            const answerTextarea = cardElement.querySelector('.edit-answer');
            const newQuestion = questionTextarea.value;
            const newAnswer = answerTextarea.value;

            generatedCardsData[index].question = newQuestion;
            generatedCardsData[index].answer = newAnswer;

            const questionSpan = cardElement.querySelector('.card-question');
            const answerSpan = cardElement.querySelector('.card-answer');
            questionSpan.innerHTML = marked.parseInline(newQuestion);
            answerSpan.innerHTML = marked.parseInline(newAnswer);

            if (window.MathJax) {
                MathJax.typesetPromise([questionSpan, answerSpan]);
            }

            cardElement.querySelector('.card-content').style.display = 'block';
            cardElement.querySelector('.edit-form').style.display = 'none';
        }
    });

    saveCardsBtn.addEventListener('click', function() {
        const approvedCards = [];
        const cardElements = cardsModalBody.querySelectorAll('.card');

        cardElements.forEach(cardElement => {
            const index = parseInt(cardElement.dataset.cardIndex, 10);
            const isApproved = cardElement.querySelector('.approve-checkbox').checked;

            if (isApproved && generatedCardsData[index]) {
                approvedCards.push(generatedCardsData[index]);
            }
        });

        if (approvedCards.length === 0) {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'warning',
                title: 'No approved cards to save.',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
            return;
        }

        fetch('/api/save-cards', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cards: approvedCards })
        })
        .then(response => {
             if (!response.ok) {
                return response.json().then(err => { throw new Error(err.detail || `HTTP error! status: ${response.status}`) });
            }
            return response.json();
        })
        .then(data => {
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: data.message,
            });
            cardsModal.hide();
        })
        .catch(error => {
             Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'error',
                title: `An error occurred: ${error.message}`,
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
            console.error(error);
        });
    });
});
</script>
{% endblock %}
<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // These values are needed for the OAuth callback handler to work globally.
    // The Jinja2 'or' filter prevents errors on pages where they aren't passed.
    const supabaseUrl = "{{ supabase_url or '' }}";
    const supabaseKey = "{{ supabase_key or '' }}";

    if (supabaseUrl && supabaseKey) {
        const supabase = createClient(supabaseUrl, supabaseKey);

        // This handles the OAuth redirect. It runs on every page load.
        // If the URL has the token, it gets the session and sends it to our backend.
        if (window.location.hash.includes('access_token')) {
            supabase.auth.getSession().then(async ({ data: { session }, error }) => {
                if (error) {
                    console.error("Error getting session from URL:", error.message);
                    return;
                }

                if (session) {
                    const response = await fetch('/auth/callback', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            access_token: session.access_token,
                            refresh_token: session.refresh_token,
                        }),
                    });

                    if (response.ok) {
                        const data = await response.json();
                        // Clear the hash from the URL and redirect to the URL provided by the backend.
                        window.location.hash = '';
                        window.location.href = data.redirect_url || '/'; // Fallback to home
                    } else {
                        console.error('Backend login failed.');
                        alert('There was an error logging you in. Please try again.');
                    }
                }
            });
        }
    }
</script>
<script>
  window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
</script>
<script defer src="/_vercel/speed-insights/script.js"></script>
</body>
</html>
