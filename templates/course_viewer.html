
{% extends "layout.html" %}

{% block title %}{{ metadata.get('title', 'Course') }}{% endblock %}

{% block head %}
{{ super() }}
<style>
    .course-header {
        margin-bottom: 0;
    }
    .course-title {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    .card-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 1rem;
    }
    .card-tag {
        display: inline-block;
        padding: 4px 14px;
        font-size: 0.9rem;
        border-radius: 16px;
        background: #e9ecef;
        color: #495057;
        text-decoration: none;
        transition: background-color 0.2s, color 0.2s;
    }
    .card-tag:hover {
        background: #0d6efd;
        color: #fff;
    }
    .course-meta {
        font-size: 0.9rem;
        color: #6c757d;
    }

    @media (max-width: 768px) {
        .course-title {
            font-size: 1.8rem;
        }
        .course-title-bar {
            /* This class is no longer in use with the new flexbox layout */
        }
        .edit-course-btn {
            margin-top: 1rem;
        }
    }
    @media (min-width: 768px) {
        .edit-course-btn {
            margin-top: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-md-between align-items-md-center mb-3">
    <h1 class="course-title">{{ metadata.get('title', 'Untitled Course') }}</h1>
    <div class="btn-group" role="group" aria-label="Course Actions">
        <a href="/edit-course/{{ course_path | urlencode }}" class="btn btn-primary edit-course-btn">Edit Course</a>
        <button type="button" id="download-btn" class="btn btn-info">Download File</button>
        <div class="btn-group" role="group">
            <button type="button" id="generate-cards-btn" class="btn {{ 'btn-success' if gemini_api_key_exists or anthropic_api_key_exists else 'btn-secondary' }} dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" {% if not gemini_api_key_exists and not anthropic_api_key_exists %}disabled{% endif %}>
                Generate Cards
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                {% if gemini_api_key_exists %}
                    <li><a class="dropdown-item" href="#" id="generate-cards-gemini-btn">Using Gemini</a></li>
                {% endif %}
                {% if anthropic_api_key_exists %}
                    <li><a class="dropdown-item" href="#" id="generate-cards-anthropic-btn">Using Anthropic</a></li>
                {% endif %}
                <li><hr class="dropdown-divider"></li>
                <li class="d-none d-lg-block"><a class="dropdown-item" href="#" id="generate-cards-ollama-btn">Using Ollama</a></li>
            </ul>
        </div>
    </div>
</div>

    <!-- Tags as stylized buttons -->
    {% if metadata.get('tags') %}
        <div class="card-tags mb-3">
            {% for tag in metadata.get('tags') %}
                <a href="/tags/{{ tag }}" class="card-tag">{{ tag }}</a>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Other metadata -->
    <div class="course-meta mb-4">
        {% if metadata.get('created') %}
            <span>Created: {{ metadata.get('created') }}</span>
        {% endif %}
        {% if metadata.get('updated') %}
            <span class="ms-3">Updated: {{ metadata.get('updated') }}</span>
        {% endif %}
    </div>

    <hr>

    <!-- Rendered Markdown Content -->
    <div id="course-content" class="mt-4">
        <!-- The actual markdown content will be placed here by the script -->
    </div>

    <!-- Hidden div to store the raw content for the script -->
    <div id="raw-content" style="display: none;">{{ content | e }}</div>
</div>

<!-- Card Generation Modal -->
<div class="modal fade" id="cards-modal" tabindex="-1" aria-labelledby="cardsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cardsModalLabel">Generated Cards</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="cards-modal-body-content"></div>
                <div id="loading-spinner" class="text-center" style="display: none;">
                    <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                    <p>Generating cards, please wait...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="save-cards-btn">Save Approved Cards</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const courseContentDiv = document.getElementById('course-content');
        const rawContentDiv = document.getElementById('raw-content');
        const rawContent = rawContentDiv.textContent;

        // Use a promise to handle the asynchronous nature of parsing and typesetting
        new Promise((resolve) => {
            // Parse the markdown content
            const htmlContent = marked.parse(rawContent);
            courseContentDiv.innerHTML = htmlContent;
            resolve();
        }).then(() => {
            // Once the content is set, typeset it with MathJax
            if (window.MathJax && window.MathJax.startup) {
                return window.MathJax.typesetPromise([courseContentDiv]);
            }
        }).catch(error => {
            console.error("Error rendering course content:", error);
        });

        const downloadBtn = document.getElementById('download-btn');
        if(downloadBtn) {
            downloadBtn.addEventListener('click', function() {
                const coursePath = "{{ course_path }}";
                if (coursePath) {
                    const finalUrl = `/api/download-course/${encodeURIComponent(coursePath)}`;
                    window.location.href = finalUrl;
                }
            });
        }

        // --- Card Generation Logic ---
        const cardsModal = new bootstrap.Modal(document.getElementById('cards-modal'));
        const cardsModalBody = document.getElementById('cards-modal-body-content');
        const saveCardsBtn = document.getElementById('save-cards-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        let generatedCardsData = [];

        function generateCards(apiUrl) {
            const content = rawContent; // Use content from the hidden div
            if (!content.trim()) {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'warning',
                    title: 'Course content is empty.',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
                return;
            }

            cardsModalBody.innerHTML = '';
            loadingSpinner.style.display = 'block';
            saveCardsBtn.disabled = true;
            cardsModal.show();

            fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: content })
            })
            .then(handleResponse)
            .then(data => {
                loadingSpinner.style.display = 'none';
                generatedCardsData = data.cards || [];
                if (generatedCardsData.length > 0) {
                    displayGeneratedCards(generatedCardsData);
                    saveCardsBtn.disabled = false;
                } else {
                    cardsModalBody.innerHTML = '<p>No cards were generated. Try refining your course content.</p>';
                }
            })
            .catch(error => {
                loadingSpinner.style.display = 'none';
                cardsModalBody.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
                console.error('Error generating cards:', error);
            });
        }

        document.addEventListener('click', function(e) {
            if (e.target.matches('#generate-cards-gemini-btn')) {
                e.preventDefault();
                generateCards('/api/generate-cards');
            }
            if (e.target.matches('#generate-cards-anthropic-btn')) {
                e.preventDefault();
                generateCards('/api/generate-cards-anthropic');
            }
            if (e.target.matches('#generate-cards-ollama-btn')) {
                e.preventDefault();
                generateCards('/api/generate-cards-ollama');
            }
        });

        function displayGeneratedCards(cards) {
            let html = '<div id="generated-cards-container">';
            cards.forEach((card, index) => {
                const questionHTML = marked.parseInline(card.question || '');
                const answerHTML = marked.parseInline(card.answer || '');
                html += `
                    <div class="card mb-3" data-card-index="${index}">
                        <div class="card-header d-flex flex-column flex-sm-row justify-content-sm-between align-items-start align-items-sm-center">
                            <div class="form-check">
                                <input class="form-check-input approve-checkbox" type="checkbox" id="approve-${index}" checked>
                                <label class="form-check-label" for="approve-${index}">
                                    <strong>Card ${index + 1}</strong>
                                </label>
                            </div>
                            <div class="mt-2 mt-sm-0">
                                <button class="btn btn-sm btn-outline-primary edit-card-btn">Edit</button>
                                <button class="btn btn-sm btn-outline-danger delete-card-btn">Delete</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="card-content">
                                <p><strong>Q:</strong> <span class="card-question">${questionHTML}</span></p>
                                <p><strong>A:</strong> <span class="card-answer">${answerHTML}</span></p>
                            </div>
                            <div class="edit-form" style="display: none;">
                                <div class="mb-2">
                                    <label class="form-label">Question:</label>
                                    <textarea class="form-control edit-question">${card.question}</textarea>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Answer:</label>
                                    <textarea class="form-control edit-answer">${card.answer}</textarea>
                                </div>
                                <button class="btn btn-sm btn-success save-edit-btn">Save</button>
                                <button class="btn btn-sm btn-secondary cancel-edit-btn">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            cardsModalBody.innerHTML = html;
            if (window.MathJax) {
                MathJax.typesetPromise([cardsModalBody]);
            }
        }

        cardsModalBody.addEventListener('click', function(e) {
            const target = e.target;
            const cardElement = target.closest('.card');
            if (!cardElement) return;

            const index = parseInt(cardElement.dataset.cardIndex, 10);

            if (target.classList.contains('delete-card-btn')) {
                generatedCardsData[index] = null;
                cardElement.remove();
            } else if (target.classList.contains('edit-card-btn')) {
                const cardData = generatedCardsData[index];
                cardElement.querySelector('.edit-question').value = cardData.question;
                cardElement.querySelector('.edit-answer').value = cardData.answer;
                cardElement.querySelector('.card-content').style.display = 'none';
                cardElement.querySelector('.edit-form').style.display = 'block';
            } else if (target.classList.contains('cancel-edit-btn')) {
                cardElement.querySelector('.card-content').style.display = 'block';
                cardElement.querySelector('.edit-form').style.display = 'none';
            } else if (target.classList.contains('save-edit-btn')) {
                const questionTextarea = cardElement.querySelector('.edit-question');
                const answerTextarea = cardElement.querySelector('.edit-answer');
                const newQuestion = questionTextarea.value;
                const newAnswer = answerTextarea.value;

                generatedCardsData[index].question = newQuestion;
                generatedCardsData[index].answer = newAnswer;

                const questionSpan = cardElement.querySelector('.card-question');
                const answerSpan = cardElement.querySelector('.card-answer');
                questionSpan.innerHTML = marked.parseInline(newQuestion);
                answerSpan.innerHTML = marked.parseInline(newAnswer);

                if (window.MathJax) {
                    MathJax.typesetPromise([questionSpan, answerSpan]);
                }

                cardElement.querySelector('.card-content').style.display = 'block';
                cardElement.querySelector('.edit-form').style.display = 'none';
            }
        });

        saveCardsBtn.addEventListener('click', function() {
            const approvedCards = [];
            const cardElements = cardsModalBody.querySelectorAll('.card');

            cardElements.forEach(cardElement => {
                const index = parseInt(cardElement.dataset.cardIndex, 10);
                const isApproved = cardElement.querySelector('.approve-checkbox').checked;

                if (isApproved && generatedCardsData[index]) {
                    approvedCards.push(generatedCardsData[index]);
                }
            });

            if (approvedCards.length === 0) {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'warning',
                    title: 'No approved cards to save.',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
                return;
            }

            fetch('/api/save-cards', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cards: approvedCards })
            })
            .then(handleResponse)
            .then(data => {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: data.message,
                });
                cardsModal.hide();
            })
            .catch(handleError);
        });

        function handleResponse(response) {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.detail || `HTTP error! status: ${response.status}`) });
            }
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                return response.json();
            }
            return {}; 
        }

        function handleError(error) {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'error',
                title: `An error occurred: ${error.message}`,
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
            console.error(error);
        }
    });
</script>
{% endblock %}
