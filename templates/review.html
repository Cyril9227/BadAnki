
{% extends "layout.html" %}

{% block title %}Review Card - Anki Clone{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* Review page specific mobile optimizations */
    @media (max-width: 576px) {
        .card.text-center {
            margin-left: 0.5rem;
            margin-right: 0.5rem;
        }

        .card-body {
            padding: 1rem;
        }

        /* Stack buttons vertically on very small screens */
        .d-sm-flex {
            flex-direction: column;
            gap: 0.5rem;
        }

        .d-sm-flex .btn {
            width: 100%;
        }
    }

    /* Ensure question/answer text doesn't overflow */
    .question .card-text,
    .answer .card-text {
        overflow-x: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="card text-center mx-auto" style="max-width: 40rem;">
    <div class="card-header">
        Review Card
        <span id="card-type-badge" class="badge bg-info ms-2" style="display: none;">Cloze</span>
    </div>
    <div class="card-body">
        <!-- Basic Q&A card display -->
        <div id="basic-card-display">
            <div class="question">
                <h5 class="card-title">Question</h5>
                <div class="card-text fs-4 markdown-content" id="basic-question" data-content="{{ card.question }}"></div>
            </div>
            <hr>
            <div class="answer" id="basic-answer" style="display: none;">
                <h5 class="card-title">Answer</h5>
                <div class="card-text fs-4 markdown-content" data-content="{{ card.answer }}"></div>
            </div>
        </div>

        <!-- Cloze card display -->
        <div id="cloze-card-display" style="display: none;">
            <div class="question">
                <h5 class="card-title">Fill in the blank</h5>
                <div class="card-text fs-4" id="cloze-question"></div>
            </div>
            <hr>
            <div class="answer" id="cloze-answer" style="display: none;">
                <h5 class="card-title">Answer</h5>
                <div class="card-text fs-4" id="cloze-revealed"></div>
            </div>
        </div>
    </div>
    <div class="card-footer text-muted">
        <button class="btn btn-primary" id="show-answer-btn" onclick="showAnswer()">Show Answer</button>

        <form id="review-form" action="/review/{{ card.id }}" method="post" class="mt-3" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                <button type="submit" name="status" value="remembered" class="btn btn-success">Remembered</button>
                <button type="submit" name="status" value="forgot" class="btn btn-danger">Forgot</button>
            </div>
        </form>
    </div>
</div>

<!-- Store raw card data for JavaScript -->
<script id="card-data" type="application/json">
{
    "question": {{ card.question | tojson }},
    "answer": {{ card.answer | tojson }},
    "card_type": {{ (card.card_type or 'basic') | tojson }}
}
</script>

<div class="card mt-4 mx-auto" style="max-width: 40rem;">
    <div class="card-header">
        Deck Status
    </div>
    <ul class="list-group list-group-flush">
        <li class="list-group-item d-flex justify-content-between align-items-center">
            Total Cards
            <span class="badge bg-primary rounded-pill">{{ total_cards }}</span>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
            Due Today
            <span class="badge bg-warning text-dark rounded-pill">{{ due_today_count }}</span>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
            New Cards
            <span class="badge bg-info text-dark rounded-pill">{{ new_cards_count }}</span>
        </li>
    </ul>
</div>

{% if learning_cards %}
<div class="card mt-4 mx-auto" style="max-width: 40rem;">
    <div class="card-header">
        Cards in Learning
    </div>
    <ul class="list-group list-group-flush">
        {% for lcard in learning_cards %}
        <li class="list-group-item markdown-content" data-content="{{ lcard.question }}">
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        // Get card data
        const cardDataEl = document.getElementById('card-data');
        const cardData = JSON.parse(cardDataEl.textContent);

        // Detect if this is a cloze card (either by card_type or by pattern)
        const clozePattern = /\{\{c\d+::([^}]+)\}\}/;
        const isCloze = cardData.card_type === 'cloze' || clozePattern.test(cardData.question);

        if (isCloze) {
            // Show cloze card display, hide basic
            document.getElementById('basic-card-display').style.display = 'none';
            document.getElementById('cloze-card-display').style.display = 'block';
            document.getElementById('card-type-badge').style.display = 'inline';

            // Format cloze question (replace cloze syntax with [...])
            const clozeQuestion = cardData.question.replace(/\{\{c\d+::([^}]+)\}\}/g,
                '<span class="cloze-blank">[...]</span>');
            document.getElementById('cloze-question').innerHTML = window.safeMarkdown(clozeQuestion);

            // Format cloze answer (replace cloze syntax with highlighted answer)
            const clozeRevealed = cardData.question.replace(/\{\{c\d+::([^}]+)\}\}/g,
                '<span class="cloze-answer">$1</span>');
            document.getElementById('cloze-revealed').innerHTML = window.safeMarkdown(clozeRevealed);
        } else {
            // Basic Q&A card - render as before
            document.querySelectorAll('.markdown-content').forEach(function(el) {
                const rawContent = el.dataset.content;
                if (rawContent) {
                    el.innerHTML = window.safeMarkdown(rawContent);
                }
            });
        }

        // After parsing, tell MathJax to typeset the new content
        if (window.MathJax) {
            MathJax.typesetPromise();
        }
    });

    function showAnswer() {
        // Show the appropriate answer section based on card type
        const basicAnswer = document.getElementById('basic-answer');
        const clozeAnswer = document.getElementById('cloze-answer');

        if (basicAnswer.closest('#basic-card-display').style.display !== 'none') {
            basicAnswer.style.display = 'block';
        } else {
            clozeAnswer.style.display = 'block';
        }

        document.getElementById('review-form').style.display = 'block';
        document.getElementById('show-answer-btn').style.display = 'none';

        // Re-typeset MathJax after showing answer
        if (window.MathJax) {
            MathJax.typesetPromise();
        }
    }
</script>
{% endblock %}
